name: Forward Bootstrap Intake To Private Registration Repo

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

concurrency:
  group: intake-forward-${{ github.event.issue.id }}
  cancel-in-progress: false

jobs:
  forward:
    if: >
      contains(github.event.issue.labels.*.name, 'registration-intake') ||
      startsWith(github.event.issue.title, 'Registration Intake:') ||
      contains(github.event.issue.body, 'Source: bootstrap-intake')
    runs-on: ubuntu-latest
    steps:
      - name: Extract Hub ID from intake issue
        id: hub
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const m = body.match(/Hub ID:\s*([a-f0-9-]{8,})/i);
            if (!m) {
              core.setFailed("Hub ID not found in intake issue body.");
              return;
            }
            core.setOutput("hub_id", m[1].trim());

      - name: Forward issue to private registration repo
        uses: actions/github-script@v7
        env:
          REG_OWNER: gputtasw
          REG_REPO: ccd-hub-registration-private
          REG_TOKEN: ${{ secrets.CCD_REGISTRATION_REPO_TOKEN }}
        with:
          github-token: ${{ env.REG_TOKEN }}
          script: |
            const hubID = "${{ steps.hub.outputs.hub_id }}";
            const intake = context.payload.issue;
            const intakeRepo = context.repo.repo;
            const intakeOwner = context.repo.owner;
            const regOwner = process.env.REG_OWNER;
            const regRepo = process.env.REG_REPO;

            if (!process.env.REG_TOKEN) {
              core.setFailed("Missing secret: CCD_REGISTRATION_REPO_TOKEN");
              return;
            }

            // Idempotency: avoid creating duplicates if workflow re-runs.
            const intakeURL = `https://github.com/${intakeOwner}/${intakeRepo}/issues/${intake.number}`;
            const q = `repo:${regOwner}/${regRepo} in:body "${intakeURL}"`;
            const search = await github.rest.search.issuesAndPullRequests({ q, per_page: 1 });
            if ((search.data.total_count || 0) > 0) {
              core.info(`Private registration issue already exists for intake issue ${intake.number}`);
              return;
            }

            const title = `Access Request: bootstrap intake (${hubID.slice(0, 8)})`;
            const body = [
              "## CCD Hub Access Request (Forwarded From Bootstrap Intake)",
              "",
              `- Hub ID: ${hubID}`,
              `- Intake Issue: ${intakeURL}`,
              `- Intake Reporter: @${intake.user.login}`,
              `- Intake Created: ${intake.created_at}`,
              "",
              "Source: bootstrap-intake-forwarder",
              "",
              "Action required:",
              "1. Validate customer details.",
              "2. Approve/reject in private registration workflow.",
            ].join("\n");

            const created = await github.rest.issues.create({
              owner: regOwner,
              repo: regRepo,
              title,
              body,
            });

            // Best-effort labels. Do not fail forwarding if label perms are restricted.
            try {
              await github.rest.issues.addLabels({
                owner: regOwner,
                repo: regRepo,
                issue_number: created.data.number,
                labels: ["access-request", "bootstrap-forwarded"],
              });
            } catch (e) {
              core.warning(`Issue created but labels could not be added: ${e.message}`);
            }
